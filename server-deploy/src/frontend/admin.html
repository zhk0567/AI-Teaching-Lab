<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员面板 - AI教学实验系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans text-slate-800">
    <!-- 顶部导航栏 -->
    <div class="bg-slate-900 text-white p-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold">管理员面板</h1>
            <span id="admin-username" class="text-gray-300">加载中...</span>
        </div>
        <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">
            退出登录
        </button>
    </div>

    <!-- 主内容区 -->
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- 用户列表 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">用户管理</h2>
                <button onclick="refreshUsers()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <i data-lucide="refresh-cw" width="18" height="18"></i>
                    刷新
                </button>
            </div>
            
            <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>
            
            <!-- 筛选和搜索区域 -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- 搜索框 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">搜索用户名</label>
                        <input type="text" id="search-input" placeholder="输入用户名搜索..." 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               oninput="applyFilters()">
                    </div>
                    
                    <!-- 组别筛选 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">组别筛选</label>
                        <select id="group-filter" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="applyFilters()">
                            <option value="">全部组别</option>
                            <option value="group1">组别1</option>
                            <option value="group2">组别2</option>
                        </select>
                    </div>
                    
                    <!-- 完成状态筛选 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">完成状态</label>
                        <select id="status-filter" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="applyFilters()">
                            <option value="">全部状态</option>
                            <option value="completed">已完成</option>
                            <option value="in-progress">进行中</option>
                        </select>
                    </div>
                    
                    <!-- 清除筛选 -->
                    <div class="flex items-end">
                        <button onclick="clearFilters()" 
                                class="w-full px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="x" width="16" height="16"></i>
                            清除筛选
                        </button>
                    </div>
                </div>
                
                <!-- 显示筛选结果统计 -->
                <div class="mt-3 text-sm text-gray-600">
                    <span id="filter-result-count">显示全部用户</span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                <button onclick="sortBy('username')" class="flex items-center gap-2 hover:text-blue-600 transition-colors">
                                    用户名
                                    <i data-lucide="chevrons-up-down" width="14" height="14" id="sort-username-icon"></i>
                                </button>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                <button onclick="sortBy('group')" class="flex items-center gap-2 hover:text-blue-600 transition-colors">
                                    组别
                                    <i data-lucide="chevrons-up-down" width="14" height="14" id="sort-group-icon"></i>
                                </button>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                <button onclick="sortBy('turnCount')" class="flex items-center gap-2 hover:text-blue-600 transition-colors">
                                    当前进度
                                    <i data-lucide="chevrons-up-down" width="14" height="14" id="sort-turnCount-icon"></i>
                                </button>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">
                                <button onclick="sortBy('completed')" class="flex items-center gap-2 hover:text-blue-600 transition-colors">
                                    完成状态
                                    <i data-lucide="chevrons-up-down" width="14" height="14" id="sort-completed-icon"></i>
                                </button>
                            </th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">额度设置</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">操作</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex items-center justify-center gap-2">
                                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                    <span>加载中...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 编辑用户弹窗 -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">编辑用户</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" width="24" height="24"></i>
                </button>
            </div>
            
            <form id="edit-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">用户名</label>
                    <input type="text" id="edit-username" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">组别</label>
                    <input type="text" id="edit-group" readonly
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">当前轮次</label>
                    <input type="number" id="edit-turnCount" min="0" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="edit-completed" class="w-4 h-4 text-blue-600 rounded">
                        <span class="text-sm font-medium text-gray-700">标记为已完成</span>
                    </label>
                </div>
                
                <div id="quota-section" class="space-y-3 border-t pt-4">
                    <h4 class="font-semibold text-gray-700">额度设置</h4>
                    <div id="group1-quota" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">最大轮次 (Group1)</label>
                        <input type="number" id="edit-maxTurns" min="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div id="group2-quota" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">目标轮次 (Group2)</label>
                        <input type="number" id="edit-targetTurns" min="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div id="edit-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeEditModal()" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button type="submit" 
                            class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        保存
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- JavaScript模块 -->
    <script src="js/config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/api.js"></script>
    <script>
        let currentEditUser = null;

        // 检查登录状态
        (function() {
            const token = (typeof Storage !== 'undefined' && Storage.getAuthToken) 
                ? Storage.getAuthToken() 
                : localStorage.getItem('auth_token');
            if (!token) {
                window.location.href = 'cplus.html';
                return;
            }

            // 验证token（添加超时保护，缩短到5秒）
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('验证超时，请检查后端服务器是否运行')), 5000)
            );
            
            Promise.race([
                fetch(`${CONFIG.API_BASE_URL}/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ token: token })
                }),
                timeoutPromise
            ])
            .then(res => {
                if (!res || !res.ok) {
                    // 401是正常情况（Token过期或无效），静默处理
                    const error = new Error('Token验证失败');
                    error.status = res?.status || 401;
                    throw error;
                }
                return res.json();
            })
            .then(data => {
                if (!data.success) {
                    // Token无效，静默处理，跳转到登录页
                    if (typeof Storage !== 'undefined' && Storage.clearAuth) {
                        Storage.clearAuth();
                    } else {
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user_info');
                    }
                    window.location.href = 'cplus.html';
                    return;
                }
                
                if (!data.isAdmin) {
                    // 非管理员用户，静默处理
                    if (typeof Storage !== 'undefined' && Storage.clearAuth) {
                        Storage.clearAuth();
                    } else {
                        localStorage.removeItem('auth_token');
                        localStorage.removeItem('user_info');
                    }
                    window.location.href = 'cplus.html';
                    return;
                }
                
                // 管理员验证通过
                document.getElementById('admin-username').textContent = data.username;
                loadUsers().then(() => {
                    // 初始化排序图标
                    setTimeout(() => {
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }, 500);
                });
            })
            .catch((error) => {
                // Token验证失败是正常情况（比如服务器重启、Token过期等），静默处理
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isDevelopment && error.status !== 401) {
                    // 只在开发环境且非401错误时显示详细错误
                    console.warn('Token验证错误:', error.message);
                }
                
                // 清除认证信息并跳转
                if (typeof Storage !== 'undefined' && Storage.clearAuth) {
                    Storage.clearAuth();
                } else {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_info');
                }
                window.location.href = 'cplus.html';
            });
        })();

        // 加载状态和请求控制
        let isLoadingUsers = false;
        let currentLoadAbortController = null;
        
        // 加载用户列表
        async function loadUsers() {
            // 如果正在加载，取消之前的请求
            if (isLoadingUsers) {
                console.log('[前端] 已有加载请求在进行，取消之前的请求');
                if (currentLoadAbortController) {
                    currentLoadAbortController.abort();
                }
            }
            
            // 创建新的 AbortController
            currentLoadAbortController = new AbortController();
            isLoadingUsers = true;
            
            // 显示加载状态
            const tbody = document.getElementById('users-table-body');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex items-center justify-center gap-2">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600"></div>
                                <span>加载中...</span>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            try {
                const users = await API.getUsers(currentLoadAbortController.signal);
                
                // 简单验证：确保是数组
                if (!Array.isArray(users)) {
                    throw new Error('服务器返回的数据格式错误');
                }
                
                // 容错处理：补充缺失字段
                users.forEach(user => {
                    if (!user.username && user.student_id) {
                        user.username = user.student_id;
                    }
                    if (!user.progress) {
                        user.progress = { turnCount: 0, completed: false };
                    }
                });
                
                // 检查请求是否被取消
                if (currentLoadAbortController?.signal.aborted) {
                    console.log('[前端] 请求已被取消，忽略结果');
                    return;
                }
                
                // 存储原始用户列表
                usersList = users;
                
                // 应用筛选和排序
                filterAndRender();
            } catch (error) {
                // 如果请求被取消，不显示错误
                if (error.name === 'AbortError' || currentLoadAbortController?.signal.aborted) {
                    console.log('[前端] 请求已被取消');
                    return;
                }
                
                console.error('加载用户列表失败:', error.message);
                showError('加载用户列表失败: ' + error.message);
                
                // 如果是因为超时或网络错误，提供重试按钮
                const tbody = document.getElementById('users-table-body');
                if (error.message.includes('超时') || error.message.includes('网络') || error.message.includes('Failed to fetch') || error.message.includes('请求超时')) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center">
                                <div class="space-y-3">
                                    <p class="text-red-600 font-semibold">${error.message}</p>
                                    <p class="text-sm text-gray-500">请检查后端服务器是否运行（${CONFIG.API_BASE_URL || 'http://113.47.7.91'}）</p>
                                    <button onclick="loadUsers()" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        重试
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    // 其他错误，显示错误信息
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center">
                                <div class="space-y-3">
                                    <p class="text-red-600 font-semibold">加载失败</p>
                                    <p class="text-sm text-gray-500">${error.message}</p>
                                    <button onclick="loadUsers()" 
                                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                        重试
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            } finally {
                // 清除加载状态
                isLoadingUsers = false;
                currentLoadAbortController = null;
            }
        }

        // 渲染用户列表（接收已筛选和排序的用户列表）
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">暂无符合条件的用户</td></tr>';
                return;
            }

            tbody.innerHTML = users.map((user) => {
                // 容错处理：补充缺失字段
                const username = user.username || user.student_id || '未知';
                if (!user.progress) {
                    user.progress = { turnCount: 0, completed: false };
                }
                
                const progress = user.progress;
                const turnCount = progress.turnCount || 0;
                const maxTurns = user.maxTurns || (user.group === 'group1' ? 2 : null);
                const targetTurns = user.targetTurns || (user.group === 'group2' ? 6 : null);
                
                // 判断完成状态：
                // 1. 管理员手动设置的 completed 状态
                // 2. 或者自动判断：group1达到maxTurns，group2达到targetTurns
                let isCompleted = progress.completed || false;
                if (!isCompleted) {
                    if (user.group === 'group1' && maxTurns && turnCount >= maxTurns) {
                        isCompleted = true;
                    } else if (user.group === 'group2' && targetTurns && turnCount >= targetTurns) {
                        isCompleted = true;
                    }
                }
                
                const progressText = user.group === 'group1' 
                    ? `${turnCount} / ${maxTurns || 2}`
                    : `${turnCount} / ${targetTurns || 6}`;
                const completedBadge = isCompleted
                    ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">已完成</span>'
                    : '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">进行中</span>';
                
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3">${username}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                ${user.group === 'group1' ? '组别1' : user.group === 'group2' ? '组别2' : '未知'}
                            </span>
                        </td>
                        <td class="px-4 py-3">${progressText}</td>
                        <td class="px-4 py-3">${completedBadge}</td>
                        <td class="px-4 py-3">
                            ${user.group === 'group1' 
                                ? `最大: ${user.maxTurns || 2} 轮`
                                : `目标: ${user.targetTurns || 6} 轮`}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-2">
                                <button onclick="editUser('${user.student_id || username}')" 
                                        class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-sm">
                                    编辑
                                </button>
                                <button onclick="resetUserStatus('${user.student_id || username}')" 
                                        class="px-3 py-1 bg-orange-600 text-white rounded hover:bg-orange-700 transition-colors text-sm">
                                    重置
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).filter(row => row !== '').join(''); // 过滤掉空行
            
            lucide.createIcons();
        }

        // 存储用户列表数据
        let usersList = [];
        
        // 筛选和排序状态
        let filterState = {
            search: '',
            group: '',
            status: ''
        };
        
        let sortState = {
            field: null,
            direction: 'asc' // 'asc' or 'desc'
        };
        
        // 应用筛选
        function applyFilters() {
            filterState.search = document.getElementById('search-input')?.value || '';
            filterState.group = document.getElementById('group-filter')?.value || '';
            filterState.status = document.getElementById('status-filter')?.value || '';
            
            filterAndRender();
        }
        
        // 清除筛选
        function clearFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('group-filter').value = '';
            document.getElementById('status-filter').value = '';
            
            filterState = {
                search: '',
                group: '',
                status: ''
            };
            
            filterAndRender();
        }
        
        // 排序
        function sortBy(field) {
            if (sortState.field === field) {
                // 如果点击同一列，切换排序方向
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果点击不同列，设置新列并默认升序
                sortState.field = field;
                sortState.direction = 'asc';
            }
            
            // 更新排序图标
            updateSortIcons();
            
            filterAndRender();
        }
        
        // 更新排序图标
        function updateSortIcons() {
            // 重置所有图标
            const icons = ['sort-username-icon', 'sort-group-icon', 'sort-turnCount-icon', 'sort-completed-icon'];
            icons.forEach(iconId => {
                const icon = document.getElementById(iconId);
                if (icon) {
                    icon.setAttribute('data-lucide', 'chevrons-up-down');
                    icon.style.opacity = '0.5';
                }
            });
            
            // 设置当前排序列的图标
            const fieldMap = {
                'username': 'sort-username-icon',
                'group': 'sort-group-icon',
                'turnCount': 'sort-turnCount-icon',
                'completed': 'sort-completed-icon'
            };
            
            const currentIconId = fieldMap[sortState.field];
            if (currentIconId) {
                const icon = document.getElementById(currentIconId);
                if (icon) {
                    const iconName = sortState.direction === 'asc' ? 'chevron-up' : 'chevron-down';
                    icon.setAttribute('data-lucide', iconName);
                    icon.style.opacity = '1';
                }
            }
            
            // 重新初始化图标
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // 筛选和渲染
        function filterAndRender() {
            if (!usersList || usersList.length === 0) {
                return;
            }
            
            // 应用筛选
            let filteredUsers = usersList.filter(user => {
                // 搜索筛选
                if (filterState.search) {
                    const username = (user.username || user.student_id || '').toLowerCase();
                    const searchTerm = filterState.search.toLowerCase();
                    if (!username.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // 组别筛选
                if (filterState.group && user.group !== filterState.group) {
                    return false;
                }
                
                // 状态筛选
                if (filterState.status) {
                    const progress = user.progress || { turnCount: 0, completed: false };
                    const turnCount = progress.turnCount || 0;
                    const maxTurns = user.maxTurns || (user.group === 'group1' ? 2 : null);
                    const targetTurns = user.targetTurns || (user.group === 'group2' ? 6 : null);
                    
                    let isCompleted = progress.completed || false;
                    if (!isCompleted) {
                        if (user.group === 'group1' && maxTurns && turnCount >= maxTurns) {
                            isCompleted = true;
                        } else if (user.group === 'group2' && targetTurns && turnCount >= targetTurns) {
                            isCompleted = true;
                        }
                    }
                    
                    if (filterState.status === 'completed' && !isCompleted) {
                        return false;
                    }
                    if (filterState.status === 'in-progress' && isCompleted) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // 应用排序
            if (sortState.field) {
                filteredUsers.sort((a, b) => {
                    let aValue, bValue;
                    
                    switch (sortState.field) {
                        case 'username':
                            aValue = (a.username || a.student_id || '').toLowerCase();
                            bValue = (b.username || b.student_id || '').toLowerCase();
                            break;
                        case 'group':
                            aValue = a.group || '';
                            bValue = b.group || '';
                            break;
                        case 'turnCount':
                            aValue = (a.progress || {}).turnCount || 0;
                            bValue = (b.progress || {}).turnCount || 0;
                            break;
                        case 'completed':
                            const aProgress = a.progress || { turnCount: 0, completed: false };
                            const bProgress = b.progress || { turnCount: 0, completed: false };
                            const aTurnCount = aProgress.turnCount || 0;
                            const bTurnCount = bProgress.turnCount || 0;
                            const aMaxTurns = a.maxTurns || (a.group === 'group1' ? 2 : null);
                            const bMaxTurns = b.maxTurns || (b.group === 'group1' ? 2 : null);
                            const aTargetTurns = a.targetTurns || (a.group === 'group2' ? 6 : null);
                            const bTargetTurns = b.targetTurns || (b.group === 'group2' ? 6 : null);
                            
                            let aCompleted = aProgress.completed || false;
                            let bCompleted = bProgress.completed || false;
                            
                            if (!aCompleted) {
                                if (a.group === 'group1' && aMaxTurns && aTurnCount >= aMaxTurns) {
                                    aCompleted = true;
                                } else if (a.group === 'group2' && aTargetTurns && aTurnCount >= aTargetTurns) {
                                    aCompleted = true;
                                }
                            }
                            
                            if (!bCompleted) {
                                if (b.group === 'group1' && bMaxTurns && bTurnCount >= bMaxTurns) {
                                    bCompleted = true;
                                } else if (b.group === 'group2' && bTargetTurns && bTurnCount >= bTargetTurns) {
                                    bCompleted = true;
                                }
                            }
                            
                            aValue = aCompleted ? 1 : 0;
                            bValue = bCompleted ? 1 : 0;
                            break;
                        default:
                            return 0;
                    }
                    
                    // 比较值
                    if (aValue < bValue) {
                        return sortState.direction === 'asc' ? -1 : 1;
                    }
                    if (aValue > bValue) {
                        return sortState.direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            // 更新结果统计
            const resultCount = document.getElementById('filter-result-count');
            if (resultCount) {
                const total = usersList.length;
                const filtered = filteredUsers.length;
                if (filtered === total) {
                    resultCount.textContent = `显示全部 ${total} 个用户`;
                } else {
                    resultCount.textContent = `显示 ${filtered} / ${total} 个用户`;
                }
            }
            
            // 渲染筛选后的用户列表
            renderUsers(filteredUsers);
        }

        // 编辑用户
        function editUser(identifier) {
            const user = usersList.find(u => u.username === identifier || u.student_id === identifier);
            
            if (!user) {
                showError('无法找到用户数据，请刷新页面重试');
                return;
            }
            
            // 容错处理：补充缺失字段
            if (!user.username && user.student_id) {
                user.username = user.student_id;
            }
            if (!user.progress) {
                user.progress = { turnCount: 0, completed: false };
            }
            if (!user.group) {
                user.group = 'group1';
            }
            
            // 保存当前编辑的用户
            currentEditUser = user;
            
            // 填充表单
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-group').value = user.group === 'group1' ? '组别1' : '组别2';
            document.getElementById('edit-turnCount').value = user.progress.turnCount || 0;
            document.getElementById('edit-completed').checked = user.progress.completed || false;
            
            // 显示/隐藏额度设置
            const group1Quota = document.getElementById('group1-quota');
            const group2Quota = document.getElementById('group2-quota');
            const maxTurnsInput = document.getElementById('edit-maxTurns');
            const targetTurnsInput = document.getElementById('edit-targetTurns');
            
            if (user.group === 'group1') {
                group1Quota.classList.remove('hidden');
                group2Quota.classList.add('hidden');
                maxTurnsInput.value = user.maxTurns || 2;
                // 设置 required 属性：显示时设为 required，隐藏时移除
                maxTurnsInput.setAttribute('required', 'required');
                targetTurnsInput.removeAttribute('required');
            } else {
                group1Quota.classList.add('hidden');
                group2Quota.classList.remove('hidden');
                targetTurnsInput.value = user.targetTurns || 6;
                // 设置 required 属性：显示时设为 required，隐藏时移除
                targetTurnsInput.setAttribute('required', 'required');
                maxTurnsInput.removeAttribute('required');
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        // 关闭编辑弹窗
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            currentEditUser = null;
            document.getElementById('edit-error').classList.add('hidden');
            // 移除所有 required 属性，避免隐藏字段验证错误
            document.getElementById('edit-maxTurns').removeAttribute('required');
            document.getElementById('edit-targetTurns').removeAttribute('required');
        }

        // 重置用户状态
        async function resetUserStatus(identifier) {
            const user = usersList.find(u => u.username === identifier || u.student_id === identifier);
            
            if (!user) {
                showError('无法找到用户数据，请刷新页面重试');
                return;
            }

            const username = user.username || user.student_id;
            
            // 确认对话框
            if (!confirm(`确定要重置用户 "${username}" 的状态吗？\n\n这将：\n- 将轮次重置为 0\n- 将完成状态重置为未完成\n- 清除今天的会话记录`)) {
                return;
            }

            try {
                const result = await API.resetUserStatus(username);
                console.log('[前端] 重置用户状态成功:', result);
                
                // 显示成功消息
                showSuccess(`用户 "${username}" 的状态已重置`);
                
                // 刷新用户列表
                await loadUsers();
                // 重新应用筛选和排序
                filterAndRender();
            } catch (error) {
                console.error('[前端] 重置用户状态失败:', error);
                showError('重置状态失败: ' + error.message);
            }
        }

        // 保存编辑
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('edit-error');
            errorDiv.classList.add('hidden');
            
            if (!currentEditUser) {
                errorDiv.textContent = '错误：用户数据丢失，请刷新页面重试';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // 容错处理
            if (!currentEditUser.username && currentEditUser.student_id) {
                currentEditUser.username = currentEditUser.student_id;
            }
            if (!currentEditUser.group) {
                currentEditUser.group = 'group1';
            }
            
            try {
                const turnCountInput = document.getElementById('edit-turnCount').value;
                const turnCount = parseInt(turnCountInput);
                
                // 验证 turnCount
                if (isNaN(turnCount) || turnCount < 0) {
                    throw new Error('轮次数量必须是大于等于0的整数');
                }
                
                const completed = document.getElementById('edit-completed').checked;
                
                // 保存进度
                console.log('[前端] 保存用户进度:', {
                    username: currentEditUser.username,
                    turnCount: turnCount,
                    completed: completed,
                    completedType: typeof completed
                });
                
                const progressResult = await API.setUserProgress(currentEditUser.username, turnCount, completed);
                console.log('[前端] 保存进度响应:', progressResult);
                
                // 保存额度
                if (currentEditUser.group === 'group1') {
                    const maxTurns = parseInt(document.getElementById('edit-maxTurns').value);
                    if (isNaN(maxTurns) || maxTurns < 1) {
                        throw new Error('最大轮次必须是大于0的整数');
                    }
                    console.log('[前端] 保存group1额度:', currentEditUser.username, 'maxTurns:', maxTurns);
                    await API.setUserQuota(currentEditUser.username, maxTurns, undefined);
                } else {
                    const targetTurns = parseInt(document.getElementById('edit-targetTurns').value);
                    if (isNaN(targetTurns) || targetTurns < 1) {
                        throw new Error('目标轮次必须是大于0的整数');
                    }
                    console.log('[前端] 保存group2额度:', currentEditUser.username, 'targetTurns:', targetTurns);
                    await API.setUserQuota(currentEditUser.username, undefined, targetTurns);
                }
                
                console.log('[前端] 保存完成，等待1秒后刷新用户列表...');
                closeEditModal();
                
                // 等待1秒，确保数据库写入完成
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                await loadUsers();
                // 重新应用筛选和排序
                filterAndRender();
                console.log('[前端] 用户列表已刷新');
            } catch (error) {
                errorDiv.textContent = '保存失败: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        });

        // 刷新用户列表（添加防抖）
        let refreshTimeout = null;
        function refreshUsers() {
            // 清除之前的定时器
            if (refreshTimeout) {
                clearTimeout(refreshTimeout);
            }
            
            // 如果正在加载，直接返回
            if (isLoadingUsers) {
                console.log('[前端] 正在加载中，忽略刷新请求');
                return;
            }
            
            // 防抖：300ms内只执行一次
            refreshTimeout = setTimeout(() => {
                loadUsers().then(() => {
                    // 重新应用筛选和排序
                    filterAndRender();
                });
                refreshTimeout = null;
            }, 300);
        }

        // 显示错误信息
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.className = 'px-4 py-3 bg-green-100 text-green-800 rounded-lg mb-4';
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
                errorDiv.className = 'px-4 py-3 bg-red-100 text-red-800 rounded-lg mb-4 hidden';
            }, 3000);
        }

        // 登出
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                if (typeof Storage !== 'undefined' && Storage.clearAuth) {
                    Storage.clearAuth();
                } else {
                    localStorage.removeItem('auth_token');
                    localStorage.removeItem('user_info');
                }
                window.location.href = 'cplus.html';
            }
        }

        // 初始化图标
        lucide.createIcons();
    </script>
</body>
</html>

