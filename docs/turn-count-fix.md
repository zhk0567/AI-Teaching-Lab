# 轮次计数问题修复说明

## 问题描述

用户只问了一个问题，但系统显示用了两次。这可能是由于：
1. 前端重复发送请求（按钮被快速点击、网络重试）
2. 后端重复保存消息
3. 前端和后端轮次计数不同步

## 修复内容

### 1. 前端请求去重机制

**文件**: `src/frontend/js/main.js`

- 添加 `_isSendingMessage` 标志，防止重复发送
- 在发送消息前检查是否正在发送，如果是则直接返回
- 在请求完成或失败后清除标志

```javascript
// 防止重复请求
if (this._isSendingMessage) {
    console.warn('[防重复] 消息正在发送中，忽略重复请求');
    return;
}
```

### 2. 前端详细日志记录

**文件**: `src/frontend/js/main.js`, `src/frontend/js/state.js`

添加了完整的日志记录，包括：
- 请求ID（用于追踪单个请求）
- 发送前的轮次
- API调用时间
- 轮次增加前后状态
- 错误信息

日志格式：
```
[日志] [req_xxx] 开始发送消息
[日志] [req_xxx] 调用API发送消息
[日志] [req_xxx] API响应完成
[日志] [req_xxx] 轮次增加
[日志] [req_xxx] 进度已保存
[日志] [req_xxx] 消息发送完成
```

### 3. 后端详细日志记录

**文件**: `src/backend/routes/chat.js`

添加了完整的后端日志，包括：
- 请求接收时间
- 用户信息
- 会话信息
- 轮次计算过程
- 消息保存状态
- 轮次更新前后对比

日志格式：
```
[后端日志] [req_xxx] 收到聊天请求
[后端日志] [req_xxx] 用户信息
[后端日志] [req_xxx] 轮次计算
[后端日志] [req_xxx] 用户消息已保存
[后端日志] [req_xxx] 会话轮次已更新
[后端日志] [req_xxx] 请求处理完成
```

### 4. 后端消息去重检查

**文件**: `src/backend/routes/chat.js`

在保存用户消息前，检查是否已存在：
- 相同内容
- 相同轮次
- 5秒内的重复消息

如果检测到重复，跳过保存并记录警告日志。

### 5. 轮次计数日志增强

**文件**: `src/frontend/js/state.js`

在 `incrementTurn()` 方法中添加详细日志：
- 增加前后的轮次
- 调用堆栈（帮助定位调用来源）
- 是否达到限制的检查

## 如何使用日志排查问题

### 前端日志

打开浏览器开发者工具（F12），查看 Console 标签：

1. **查找请求ID**：
   ```
   [日志] [req_1703123456789_abc123] 开始发送消息
   ```

2. **追踪整个请求流程**：
   使用请求ID搜索，查看该请求的所有日志

3. **检查轮次变化**：
   ```
   [轮次日志] incrementTurn执行
   before: 1
   after: 2
   ```

### 后端日志

在服务器上查看PM2日志：

```bash
# 查看实时日志
pm2 logs ai-teaching-backend

# 查看最近100行日志
pm2 logs ai-teaching-backend --lines 100 --nostream

# 搜索特定请求
pm2 logs ai-teaching-backend --lines 1000 --nostream | grep "req_xxx"
```

### 常见问题排查

#### 问题1: 轮次被重复增加

**检查**：
1. 前端日志中是否有多个 `incrementTurn执行` 记录
2. 检查调用堆栈，看是否从不同位置调用

**解决**：
- 检查是否有多个地方调用了 `incrementTurn()`
- 检查是否有事件监听器重复绑定

#### 问题2: 后端重复保存消息

**检查**：
1. 后端日志中是否有 "检测到重复消息" 警告
2. 数据库中是否有相同内容的消息

**解决**：
- 去重机制会自动跳过重复保存
- 检查前端是否发送了重复请求

#### 问题3: 前端和后端轮次不一致

**检查**：
1. 前端日志中的 `beforeTurnCount` 和 `afterTurnCount`
2. 后端日志中的 `beforeTurnCount` 和 `afterTurnCount`
3. 对比两者是否一致

**解决**：
- 前端轮次应该与后端数据库中的 `turn_count` 同步
- 如果不同步，检查 `saveProgress()` 和 `loadProgress()` 是否正常工作

## 部署说明

修复已同步到 `server-deploy/` 目录，上传到服务器后：

1. **重启后端服务**：
   ```bash
   pm2 restart ai-teaching-backend
   ```

2. **清除浏览器缓存**：
   - 按 Ctrl+Shift+Delete
   - 清除缓存和 Cookie
   - 重新加载页面

3. **测试**：
   - 发送一条消息
   - 检查浏览器控制台日志
   - 检查服务器日志
   - 确认轮次只增加1次

## 日志级别

- **INFO**: 正常流程日志（`[日志]`, `[后端日志]`）
- **WARN**: 警告日志（重复请求、达到限制等）
- **ERROR**: 错误日志（保存失败、API错误等）

## 注意事项

1. 日志会输出到浏览器控制台和服务器控制台，生产环境建议配置日志级别
2. 请求ID格式：`req_时间戳_随机字符串`，用于追踪单个请求的完整流程
3. 所有时间戳使用 ISO 8601 格式，便于排序和查询

