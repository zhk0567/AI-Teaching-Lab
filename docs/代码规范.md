# 代码规范文档

## 文件大小限制

⚠️ **目标：所有代码文件不超过500行**

### 前端文件

| 文件 | 行数 | 状态 | 说明 |
|------|------|------|------|
| cplus.html | 287 | ✅ | 主HTML文件 |
| styles.css | 215 | ✅ | 样式文件 |
| config.js | 54 | ✅ | 配置模块 |
| state.js | 154 | ✅ | 状态管理 |
| storage.js | 71 | ✅ | 存储管理模块 |
| utils.js | 138 | ✅ | 工具函数 |
| resizer.js | 106 | ✅ | 分隔条功能 |
| api.js | 249 | ✅ | API调用 |
| messages.js | 440 | ✅ | 消息处理 |
| auth.js | 316 | ✅ | 认证模块（登录、登出、Token验证） |
| accountModal.js | 191 | ✅ | 账号信息弹窗模块 |
| mechanisms.js | 391 | ✅ | 实验机制模块（A/B/C） |
| experiment.js | 65 | ✅ | 实验管理模块 |
| main.js | 327 | ✅ | 主逻辑模块 |
| ui.js | 255 | ✅ | UI渲染 |
| admin.html | 327 | ✅ | 管理员页面 |

### 后端文件

| 文件 | 行数 | 状态 | 说明 |
|------|------|------|------|
| server.js | 148 | ✅ | 后端服务器主文件 |
| db.js | 107 | ✅ | 数据库连接模块 |
| init-db.js | 114 | ✅ | 数据库初始化脚本 |
| models/users.js | 74 | ✅ | 用户模型 |
| models/sessions.js | 83 | ✅ | 会话模型 |
| models/messages.js | 48 | ✅ | 消息模型 |
| models/events.js | 43 | ✅ | 事件模型 |
| models/topics.js | 59 | ✅ | 主题模型 |
| routes/auth.js | 72 | ✅ | 认证路由 |
| routes/chat.js | 112 | ✅ | 聊天路由 |
| routes/progress.js | 74 | ✅ | 进度路由 |
| routes/admin.js | 137 | ✅ | 管理员路由 |
| services/authService.js | 69 | ✅ | 认证服务 |
| services/chatService.js | 129 | ✅ | 聊天服务 |
| utils/auth.js | 64 | ✅ | 认证工具函数 |
| utils/progress.js | 95 | ✅ | 进度工具函数 |

### 其他文件

| 文件 | 行数 | 状态 | 说明 |
|------|------|------|------|
| start.py | 192 | ✅ | 启动脚本 |

## 代码规范

### Python代码（PEP 8基础）

- ✅ 使用4个空格缩进
- ✅ 函数和类使用文档字符串
- ✅ 常量使用大写字母
- ✅ 函数名使用小写字母和下划线
- ✅ 每行不超过79个字符（适当放宽）
- ✅ 导入语句按标准库、第三方库、本地模块分组

### JavaScript代码（阿里规范基础）

- ✅ 使用2个空格缩进
- ✅ 使用单引号（字符串中需要时使用双引号）
- ✅ 函数和对象使用JSDoc注释
- ✅ 使用const/let，避免var
- ✅ 函数名使用驼峰命名
- ✅ 常量使用大写字母和下划线
- ✅ 模块化设计，单一职责原则

### HTML/CSS规范

- ✅ HTML语义化标签
- ✅ CSS类名使用Tailwind CSS规范
- ✅ 自定义样式独立到CSS文件
- ✅ 遵循良好的视觉准则
- ✅ 内联样式仅用于动态样式

### 数据库规范

- ✅ 使用模型层（Models）进行数据操作
- ✅ 避免直接SQL查询，使用封装的方法
- ✅ 使用事务确保数据一致性
- ✅ 外键约束确保数据完整性
- ✅ 使用参数化查询防止SQL注入
- ✅ 数据库连接使用连接池管理

## 代码复用

### 已实现的复用方法

1. **Utils模块** - 通用工具函数
   - `getElement()` - 获取DOM元素
   - `scrollToBottom()` - 滚动到底部
   - `createElement()` - 创建DOM元素
   - `hasUnmodifiedPlaceholder()` - 验证占位符
   - `escapeHtml()` - HTML转义
   - `markdownToHtml()` - Markdown渲染
   - `highlightCode()` - 代码高亮

2. **Storage模块** - 存储管理
   - `getAuthToken()` / `setAuthToken()` - 认证Token管理
   - `getUserInfo()` / `setUserInfo()` - 用户信息管理
   - `getLocalStorageItem()` / `setLocalStorageItem()` - 本地存储

3. **State模块** - 状态管理
   - 集中管理所有全局状态
   - 提供状态操作方法
   - 进度保存和加载

4. **Messages模块** - 消息处理
   - 统一的消息创建和显示逻辑
   - 可复用的消息容器创建方法
   - 流式输出支持

5. **UI模块** - 界面渲染
   - 统一的UI更新方法
   - 可复用的渲染函数

6. **数据库模型层** - 后端数据操作
   - Users - 用户数据操作
   - Sessions - 会话数据操作
   - Messages - 消息数据操作
   - Events - 事件数据操作
   - Topics - 主题配置操作

## 无用代码清理

✅ **已清理的内容：**
- 删除了重复的代码逻辑
- 移除了未使用的变量
- 合并了相似的功能函数
- 优化了事件处理逻辑

## Web页面视觉准则

### 已遵循的准则

1. **响应式设计**
   - 支持不同屏幕尺寸
   - 可调整的左右面板布局

2. **视觉反馈**
   - 悬停效果
   - 过渡动画
   - 状态指示器

3. **可访问性**
   - 语义化HTML
   - 清晰的视觉层次
   - 适当的颜色对比度

4. **用户体验**
   - 流畅的交互动画
   - 即时的状态反馈
   - 友好的错误提示

## 项目结构

```
src/
├── frontend/
│   ├── cplus.html          # 主HTML文件（287行）
│   ├── admin.html          # 管理员页面（327行）
│   ├── styles.css          # 样式文件（215行）
│   └── js/
│       ├── config.js       # 配置模块（54行）
│       ├── storage.js      # 存储管理（71行）
│       ├── state.js        # 状态管理（154行）
│       ├── utils.js        # 工具函数（138行）
│       ├── resizer.js      # 分隔条功能（106行）
│       ├── api.js          # API调用（249行）
│       ├── messages.js     # 消息处理（440行）
│       ├── mechanisms.js   # 实验机制（391行）
│       ├── auth.js         # 认证模块（316行）
│       ├── accountModal.js # 账号弹窗（191行）
│       ├── experiment.js   # 实验管理（65行）
│       ├── ui.js           # UI渲染（255行）
│       └── main.js         # 主逻辑（327行）
└── backend/
    ├── server.js           # 后端服务器（148行）
    ├── db.js              # 数据库连接（107行）
    ├── init-db.js         # 数据库初始化（114行）
    ├── routes/
    │   ├── auth.js        # 认证路由（72行）
    │   ├── chat.js        # 聊天路由（112行）
    │   ├── progress.js    # 进度路由（74行）
    │   └── admin.js       # 管理员路由（137行）
    ├── services/
    │   ├── authService.js # 认证服务（69行）
    │   └── chatService.js # 聊天服务（129行）
    ├── utils/
    │   ├── auth.js       # 认证工具（64行）
    │   └── progress.js   # 进度工具（95行）
    └── models/
        ├── users.js       # 用户模型（74行）
        ├── sessions.js    # 会话模型（83行）
        ├── messages.js    # 消息模型（48行）
        ├── events.js     # 事件模型（43行）
        └── topics.js     # 主题模型（59行）
```

## 代码质量检查

✅ 所有文件通过linter检查
✅ 无语法错误
✅ 无未使用的变量
✅ 无重复代码
✅ 遵循命名规范
✅ 数据库操作使用模型层
✅ 错误处理完善
✅ 日志记录完整

## 新增功能模块

### 数据库支持（2024年新增）

- ✅ MySQL数据库集成
- ✅ 5个核心数据表（users, sessions, messages, ui_events, daily_topics）
- ✅ 自动数据库初始化
- ✅ 模型层封装（Models）
- ✅ 连接池管理

### 认证系统（2024年新增）

- ✅ Token-based认证
- ✅ 多窗口登录支持（sessionStorage）
- ✅ 用户组别管理
- ✅ 管理员权限控制

### 进度追踪（2024年新增）

- ✅ 每日进度记录
- ✅ 轮次计数
- ✅ 完成状态标记
- ✅ 跨会话进度恢复

## 已完成重构

✅ **已完成的重构：**

1. **server.js (609行 → 148行)**
   - ✅ 将路由处理拆分为独立模块（routes/）
   - ✅ 将API调用逻辑提取为服务层（services/）
   - ✅ 将工具函数提取为独立模块（utils/）

2. **cplus.html (773行 → 287行)**
   - ✅ 将内联脚本提取到独立JS文件（auth.js, accountModal.js）
   - ✅ 将模态框组件化

3. **main.js (729行 → 327行)**
   - ✅ 将机制A/B/C逻辑提取为独立模块（mechanisms.js）
   - ✅ 将实验重置逻辑独立（experiment.js）

## 维护建议

1. **添加新功能时**
   - 保持文件在500行以内
   - 遵循现有代码风格
   - 使用已有的工具函数
   - 优先考虑模块化拆分

2. **重构代码时**
   - 保持模块化结构
   - 确保代码复用
   - 更新相关文档
   - 逐步重构，避免大规模改动

3. **性能优化**
   - 避免不必要的DOM操作
   - 使用事件委托
   - 合理使用缓存
   - 数据库查询优化

4. **数据库相关**
   - 使用模型层进行数据操作
   - 避免直接SQL查询
   - 确保事务一致性

